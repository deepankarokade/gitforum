<!DOCTYPE html>
<html>
<head>
    <title>Set Question Paper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h4>Set Demo Question Paper</h4>

    <form action="/demoquestionpaper/savedemoQuestionPaper" method="post" enctype="multipart/form-data">

        <!-- ================= EXAM DETAILS ================= -->
        <div class="card mb-4">
            <div class="card-body">
                <h6>Exam Details</h6>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label>Course Name</label>
						<select class="form-select" name="coursename" required>
												    <option value="">Select</option>
												    <option th:each="exam : ${exams}"
												            th:value="${exam.courseName}"
												            th:text="${exam.courseName}"
												            th:selected="${selectedExam != null and exam.id == selectedExam.id}">
												    </option>
												</select>                    </div>
                    <div class="col-md-4">
                        <label>Subject</label>
                        <input type="text" class="form-control" name="subject" required>
                    </div>
                    <div class="col-md-4">
                        <label>Chapter / Topic</label>
                        <input type="text" class="form-control" name="chapter" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label>Exam Duration (Minutes)</label>
                        <input type="number" class="form-control" name="duration" required>
                    </div>
                    <div class="col-md-4">
                        <label>Difficulty</label>
                        <select class="form-select" name="difficulty" required>
                            <option value="">Select</option>
                            <option>Easy</option>
                            <option>Medium</option>
                            <option>Hard</option>
                        </select>
                    </div>
						
					<div class="col-md-4">
					    <label>Set</label>
					    <select class="form-select" name="selectset" required>
					        <option value="">Select</option>
					        <option>A</option>
					        <option>B</option>
					        <option>C</option>
							<option>D</option>
							<option>None</option>


					    </select>
					</div>
					
					
                    <div class="col-md-4">
                        <label>Question Paper Image</label>
                        <input type="file" class="form-control" name="questionPaperImage">
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= QUESTIONS ================= -->
        <div id="questionsContainer"></div>

        <button type="button" class="btn btn-primary mt-3" onclick="addQuestion()">‚ûï Add Question</button>

        <div class="mt-3">
            <label>Explanation / Hint</label>
            <textarea class="form-control" name="explanation" rows="2"></textarea>
        </div>

        <div class="mt-3">
            <label>Attachment</label>
            <input type="file" class="form-control" name="attachment">
        </div>

        <div class="mt-4">
            <button class="btn btn-success">Save</button>
            <button type="reset" class="btn btn-secondary">Cancel</button>
        </div>

    </form>
</div>

<script>
let questionCount = 0;

function addQuestion() {
    const index = questionCount++;
    const div = document.createElement("div");
    div.className = "card mt-3 question-card";

    div.innerHTML = `
        <div class="card-body">

            <div class="d-flex justify-content-between mb-2">
                <h6 class="question-title">Question ${index + 1}</h6>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(this)">‚ùå</button>
            </div>

            <div class="mb-2">
                <label>Question Type</label>
                <select class="form-select" name="questions[${index}].questionType" onchange="changeType(this)" required>
                    <option value="">Select</option>
                    <option value="mcq">MCQ</option>
                    <option value="tf">True / False</option>
                    <option value="long">Long Answer</option>
                    <option value="short">Short Answer</option>
                    <option value="essay">Essay</option>
                    <option value="fill">Fill in the Blanks</option>
                    <option value="match">Match the Pair</option>
                </select>
            </div>

            <div class="mb-2">
                <label>Question Text</label>
                <textarea class="form-control" name="questions[${index}].questionText" rows="2" required></textarea>
            </div>

            <!-- MCQ -->
            <div class="mcq d-none">
                <label>Options</label>
                <div class="mcq-options">
                    <div class="d-flex mb-1">
                        <input class="form-control me-2" name="questions[${index}].options" placeholder="Option">
                        <button type="button" class="btn btn-sm btn-danger"
                            onclick="this.parentElement.remove(); updateMcqSelect(${index})">‚ùå</button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary mt-1"
                        onclick="addMcqOption(this, ${index})">‚ûï Option</button>
                <br>
                <label class="mt-2">Correct Answer</label>
                <select class="form-select" name="questions[${index}].correctAnswer"
                        id="mcqCorrectSelect${index}"></select>
            </div>

            <!-- TRUE / FALSE -->
            <div class="tf d-none">
                <label>Correct Answer</label>
                <select class="form-select" name="questions[${index}].correctAnswer">
                    <option value="True">True</option>
                    <option value="False">False</option>
                </select>
            </div>

            <!-- LONG -->
            <div class="long d-none">
                <label>Answer / Reference</label>
                <textarea class="form-control" name="questions[${index}].correctAnswer"></textarea>
            </div>

            <!-- SHORT -->
            <div class="short d-none">
                <label>Short Answer</label>
                <textarea class="form-control" name="questions[${index}].shortAnswer"></textarea>
            </div>

            <!-- ESSAY -->
            <div class="essay d-none">
                <label>Essay Answer</label>
                <textarea class="form-control" name="questions[${index}].essay"></textarea>
            </div>

            <!-- FILL -->
            <div class="fill d-none">
                <label>Blanks</label>
                <div class="fill-options">
                    <div class="d-flex mb-1">
                        <input class="form-control me-2 fillInput"
                               name="questions[${index}].fillInTheBlanks"
                               placeholder="Blank"
                               oninput="updateFillDropdown(${index})">
                        <button type="button" class="btn btn-sm btn-danger"
                                onclick="this.parentElement.remove(); updateFillDropdown(${index})">‚ùå</button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary mt-1"
                        onclick="addFillOption(this, ${index})">‚ûï Blank</button>
                <br>
                <label class="mt-2">Correct Answer</label>
                <select class="form-select" name="questions[${index}].correctAnswer"
                        id="fillCorrectSelect${index}"></select>
            </div>

            <!-- MATCH -->
            <div class="match d-none">
                <label class="fw-bold">Match the Pairs</label>
                <div class="pairs-container">
                    <div class="d-flex align-items-center mb-2">
                        <input class="form-control me-2" name="questions[${index}].leftItems" placeholder="Left Item">
                        <input class="form-control me-2" name="questions[${index}].rightItems" placeholder="Right Item">
                        <button type="button" class="btn btn-danger btn-sm"
                                onclick="this.parentElement.remove()">‚ùå</button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-primary mt-2"
                        onclick="addPair(this, ${index})">‚ûï Add Pair</button>
            </div>

            <div class="mt-2">
                <label>Marks</label>
                <input type="number" class="form-control" name="questions[${index}].marks" value="1" required>
            </div>

        </div>
    `;
    document.getElementById("questionsContainer").appendChild(div);
}

/* ===== MCQ OPTION FIX (UNCHANGED) ===== */
function addMcqOption(btn, index){
    const container = btn.previousElementSibling;
    const div = document.createElement("div");
    div.className = "d-flex mb-1";
    div.innerHTML = `
        <input class="form-control me-2"
               name="questions[${index}].options"
               placeholder="Option"
               oninput="updateMcqSelect(${index})">
        <button type="button" class="btn btn-sm btn-danger"
                onclick="this.parentElement.remove(); updateMcqSelect(${index})">‚ùå</button>
    `;
    container.appendChild(div);
    updateMcqSelect(index);
}

function updateMcqSelect(index){
    const card = document.querySelectorAll(".question-card")[index];
    const select = card.querySelector(`#mcqCorrectSelect${index}`);
    if(!select) return;
    select.innerHTML = "";
    card.querySelectorAll(`input[name='questions[${index}].options']`).forEach(opt=>{
        if(opt.value.trim()){
            select.innerHTML += `<option value="${opt.value}">${opt.value}</option>`;
        }
    });
}

function addFillOption(btn,index){
    const div=document.createElement("div");
    div.className="d-flex mb-1";
    div.innerHTML=`
        <input class="form-control me-2 fillInput"
               name="questions[${index}].fillInTheBlanks"
               placeholder="Blank"
               oninput="updateFillDropdown(${index})">
        <button type="button" class="btn btn-sm btn-danger"
                onclick="this.parentElement.remove(); updateFillDropdown(${index})">‚ùå</button>`;
    btn.previousElementSibling.appendChild(div);
}

function updateFillDropdown(index){
    const card=document.querySelectorAll(".question-card")[index];
    const select=card.querySelector(`#fillCorrectSelect${index}`);
    if(!select) return;
    select.innerHTML="";
    card.querySelectorAll(`input[name='questions[${index}].fillInTheBlanks']`).forEach(i=>{
        if(i.value.trim()){
            select.innerHTML+=`<option value="${i.value}">${i.value}</option>`;
        }
    });
}

function removeQuestion(btn){
    btn.closest(".question-card").remove();
}

/* ===== üî• ONLY IMPORTANT FIX HERE üî• ===== */
function changeType(select){
    const card = select.closest(".card-body");
    const sections = card.querySelectorAll(".mcq, .tf, .long, .short, .fill, .essay, .match");

    sections.forEach(sec => {
        sec.classList.add("d-none");
        sec.querySelectorAll("input, textarea, select").forEach(el => el.disabled = true);
    });

    if(select.value){
        const active = card.querySelector("." + select.value);
        active.classList.remove("d-none");
        active.querySelectorAll("input, textarea, select").forEach(el => el.disabled = false);
    }
}


function addPair(btn, index) {
    const container = btn.previousElementSibling; // .pairs-container

    const div = document.createElement("div");
    div.className = "d-flex align-items-center mb-2";

    div.innerHTML = `
        <input class="form-control me-2"
               name="questions[${index}].leftItems"
               placeholder="Left Item">
        <input class="form-control me-2"
               name="questions[${index}].rightItems"
               placeholder="Right Item">
        <button type="button" class="btn btn-danger btn-sm"
               onclick="this.parentElement.remove()">‚ùå</button>
    `;

    container.appendChild(div);
}

</script>

</body>
</html>
